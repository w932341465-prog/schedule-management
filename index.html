<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€¼ç­è°ƒæ•´è®°å½•è¡¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .login-section {
            background-color: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        .user-login {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .user-login input, .user-login select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .admin-login {
            display: none;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 10px;
            padding: 10px;
            background-color: rgba(255, 193, 7, 0.1);
            border-radius: 5px;
            border: 1px solid #ffc107;
        }
        .admin-login.show {
            display: flex;
        }
        .current-user {
            font-weight: bold;
            color: #1976d2;
        }
        .role-badge {
            background-color: #4caf50;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .role-badge.approver {
            background-color: #f44336;
        }
        .role-badge.employee {
            background-color: #9e9e9e;
        }
        .schedule-section {
            margin-bottom: 30px;
        }
        .schedule-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c5aa0;
        }
        .original-schedule {
            overflow-x: auto;
            margin-bottom: 30px;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            vertical-align: middle;
        }
        .schedule-table th {
            background-color: #4472C4;
            color: white;
            font-weight: bold;
        }
        .time-slot {
            background-color: #E7E6E6;
            font-weight: bold;
            writing-mode: vertical-lr;
            text-orientation: mixed;
            width: 60px;
        }
        .adjustment-form {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }
        .form-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        .form-group input, .form-group select {
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background-color: #28a745;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn:hover:not(:disabled) {
            background-color: #218838;
        }
        .btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-warning:hover:not(:disabled) {
            background-color: #e0a800;
        }
        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: #5a6268;
        }
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        .login-prompt {
            background-color: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #ffc107;
            margin-bottom: 15px;
            display: none;
        }
        .login-prompt.show {
            display: block;
        }
        .record-table {
            margin-top: 20px;
            overflow-x: auto;
        }
        .record-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        .record-table th {
            background-color: #6c757d;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 11px;
        }
        .record-table td {
            padding: 6px;
            border: 1px solid #ddd;
            text-align: center;
            font-size: 11px;
        }
        .record-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .type-è°ƒä¼‘ { background-color: #d4edda; }
        .type-åŠ ç­ { background-color: #f8d7da; }
        .type-æ¢ç­ { background-color: #d1ecf1; }
        .type-è¡¥ä¼‘ { background-color: #fff3cd; }
        .export-btn {
            background-color: #007bff;
            margin-left: 10px;
        }
        .export-btn:hover:not(:disabled) {
            background-color: #0056b3;
        }
        .status-å¾…å®¡æ‰¹ { 
            background-color: #fff3cd; 
            color: #856404;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status-å·²æ‰¹å‡† { 
            background-color: #d4edda; 
            color: #155724;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status-å·²æ‹’ç» { 
            background-color: #f8d7da; 
            color: #721c24;
            padding: 3px 8px;
            border-radius: 3px;
            font-weight: bold;
        }
        .action-btn {
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
            margin: 1px;
            min-width: 45px;
        }
        .action-btn:hover {
            opacity: 0.8;
        }
        .approve-btn { background-color: #28a745; }
        .reject-btn { background-color: #dc3545; }
        .delete-btn { background-color: #dc3545; }
        .edit-btn { background-color: #ffc107; color: #212529; }
        .withdraw-btn { background-color: #17a2b8; }
        
        .warning-text {
            color: #856404;
            font-size: 12px;
            margin-top: 10px;
        }
        .permission-info {
            background-color: #fff3cd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            border-left: 4px solid #ffc107;
        }
        .approver-notice {
            background-color: #d1ecf1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #17a2b8;
            display: none;
        }
        .approver-notice.show {
            display: block;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 5px;
        }
        .status-indicator.connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-indicator.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status-indicator.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @media (max-width: 768px) {
            .form-row, .user-info, .user-login, .admin-login {
                flex-direction: column;
                align-items: stretch;
            }
            .form-group {
                min-width: auto;
                width: 100%;
            }
            .schedule-table {
                font-size: 12px;
            }
            .schedule-table th, .schedule-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>2025/2026å­¦å¹´ä¸Šå­¦æœŸ å€¼ç­è°ƒæ•´è®°å½•è¡¨</h1>
        
        <!-- è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨ -->
        <div class="status-indicator connecting" id="connectionStatus">
            <div class="loading"></div>
            <span id="statusText">æ­£åœ¨è¿æ¥æ•°æ®åº“...</span>
        </div>
        
        <div class="login-section">
            <div class="user-info">
                <div class="user-login">
                    <select id="userType" onchange="toggleLoginType()" style="width: 120px;">
                        <option value="employee">æ™®é€šå‘˜å·¥</option>
                        <option value="approver">å®¡æ‰¹å‘˜</option>
                    </select>
                    <select id="username" style="width: 130px;">
                        <option value="">é€‰æ‹©å‘˜å·¥</option>
                        <option value="é™ˆç§€æ”»">é™ˆç§€æ”»</option>
                        <option value="è°­è¯—å®‡">è°­è¯—å®‡</option>
                        <option value="å½­æ¢…">å½­æ¢…</option>
                        <option value="åºé›¯å©•">åºé›¯å©•</option>
                        <option value="æ¨ä½³é¸¿">æ¨ä½³é¸¿</option>
                        <option value="ææµ·è±ª">ææµ·è±ª</option>
                        <option value="é¾šæ¥šæ£®">é¾šæ¥šæ£®</option>
                        <option value="åˆ˜æ™“æ¬¢">åˆ˜æ™“æ¬¢</option>
                    </select>
                    <button class="btn btn-small" onclick="login()">ç™»å½•</button>
                </div>
                
                <!-- å®¡æ‰¹å‘˜ç™»å½•åŒºåŸŸ -->
                <div class="admin-login" id="adminLogin">
                    <span style="color: #856404; font-weight: bold;">å®¡æ‰¹å‘˜ç™»å½•ï¼š</span>
                    <input type="text" id="adminUsername" placeholder="ç”¨æˆ·å" style="width: 100px;">
                    <input type="password" id="adminPassword" placeholder="å¯†ç " style="width: 100px;">
                    <button class="btn btn-small btn-warning" onclick="adminLogin()">ç™»å½•</button>
                </div>
                
                <div id="currentUserInfo" style="display: none;">
                    <span class="current-user">å½“å‰ç”¨æˆ·: <span id="currentUsername"></span></span>
                    <span class="role-badge" id="currentRole"></span>
                    <button class="btn btn-secondary btn-small" onclick="logout()">é€€å‡º</button>
                </div>
            </div>
            <div class="warning-text">
                âš ï¸ æƒé™è¯´æ˜ï¼šæ‰€æœ‰å‘˜å·¥éƒ½å¯ä»¥æäº¤ç”³è¯·å’Œæ’¤å›ç¼–è¾‘ï¼›åªæœ‰å®¡æ‰¹å‘˜å¯ä»¥å®¡æ‰¹å’Œåˆ é™¤ç”³è¯·
                <br>ğŸ”„ å®æ—¶åŒæ­¥ï¼šæ‰€æœ‰ç”¨æˆ·éƒ½èƒ½çœ‹åˆ°æœ€æ–°çš„ç”³è¯·å’Œå®¡æ‰¹çŠ¶æ€
            </div>
            <div class="permission-info">
                <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 20px;">
                    <div>
                        <strong>ğŸ“ ç”³è¯·æƒé™ï¼š</strong>æ‰€æœ‰å€¼ç­äººå‘˜
                        <br><small>ä»»ä½•å€¼ç­äººå‘˜éƒ½å¯ä»¥æäº¤è°ƒç­ç”³è¯·</small>
                    </div>
                    <div>
                        <strong>ğŸ”„ æ’¤å›ç¼–è¾‘ï¼š</strong>ç”³è¯·äººæœ¬äºº
                        <br><small>ç”³è¯·äººå¯ä»¥æ’¤å›å¾…å®¡æ‰¹çš„ç”³è¯·é‡æ–°ç¼–è¾‘</small>
                    </div>
                    <div>
                        <strong>âœ… å®¡æ‰¹æƒé™ï¼š</strong>ç‹ä½³ä¸½ã€é›·èŒã€æè™¹ç‘¶
                        <br><small>éœ€è¦ç”¨ä¸“ç”¨è´¦å·ç™»å½•æ‰èƒ½å®¡æ‰¹</small>
                    </div>
                    <div>
                        <strong>ğŸ—‘ï¸ åˆ é™¤æƒé™ï¼š</strong>ä»…é™å®¡æ‰¹å‘˜
                        <br><small>åªæœ‰å®¡æ‰¹å‘˜å¯ä»¥åˆ é™¤ä»»ä½•ç”³è¯·è®°å½•</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- å®¡æ‰¹å‘˜å®¡æ‰¹æç¤º -->
        <div class="approver-notice" id="approverNotice">
            <h4>ğŸ”° å®¡æ‰¹å‘˜æ“ä½œä¸­å¿ƒ</h4>
            <p>æ‚¨æ˜¯æŒ‡å®šå®¡æ‰¹å‘˜ï¼Œå…·æœ‰ä»¥ä¸‹æƒé™ï¼š</p>
            <ul>
                <li>ğŸ“ <strong>æäº¤ç”³è¯·</strong>ï¼šå¯ä»¥ä¸ºè‡ªå·±æˆ–ä»–äººæäº¤è°ƒç­ç”³è¯·</li>
                <li>ğŸ”„ <strong>æ’¤å›ç¼–è¾‘</strong>ï¼šå¯ä»¥æ’¤å›å¹¶ç¼–è¾‘è‡ªå·±çš„ç”³è¯·</li>
                <li>âœ… <strong>å®¡æ‰¹ç”³è¯·</strong>ï¼šå¯ä»¥åœ¨ä¸‹æ–¹"è°ƒæ•´è®°å½•"è¡¨æ ¼çš„"æ“ä½œ"æ ä¸­å®¡æ‰¹æ‰€æœ‰ç”³è¯·</li>
                <li>ğŸ—‘ï¸ <strong>åˆ é™¤è®°å½•</strong>ï¼šå¯ä»¥åˆ é™¤ä»»ä½•ç”³è¯·è®°å½•</li>
                <li>ğŸŸ¢ <strong>æ‰¹å‡†</strong>ï¼šç‚¹å‡»ç»¿è‰²"âœ“ æ‰¹å‡†"æŒ‰é’®</li>
                <li>ğŸ”´ <strong>æ‹’ç»</strong>ï¼šç‚¹å‡»çº¢è‰²"âœ— æ‹’ç»"æŒ‰é’®</li>
                <li>ğŸ—‘ï¸ <strong>åˆ é™¤</strong>ï¼šç‚¹å‡»çº¢è‰²"åˆ é™¤"æŒ‰é’®</li>
            </ul>
        </div>

        <div class="schedule-section">
            <div class="schedule-title">åŸå§‹å€¼ç­è¡¨</div>
            <div class="original-schedule">
                <table class="schedule-table">
                    <thead>
                        <tr>
                            <th>æ—¶é—´</th>
                            <th>å‘¨ä¸€</th>
                            <th>å‘¨äºŒ</th>
                            <th>å‘¨ä¸‰</th>
                            <th>å‘¨å››</th>
                            <th>å‘¨äº”</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="time-slot">10:30-13:00</td>
                            <td>é›·èŒ<br>ç‹ä½³ä¸½<br>é™ˆç§€æ”»<br>è°­è¯—å®‡</td>
                            <td>æè™¹ç‘¶<br>è°­è¯—å®‡<br>å½­æ¢…</td>
                            <td>åºé›¯å©•<br>æ¨ä½³é¸¿<br>æè™¹ç‘¶</td>
                            <td>ææµ·è±ª<br>ç‹ä½³ä¸½<br>é›·èŒ</td>
                            <td>åºé›¯å©•<br>é¾šæ¥šæ£®<br>æ¨ä½³é¸¿</td>
                        </tr>
                        <tr>
                            <td class="time-slot">15:00-17:30</td>
                            <td>ç‹ä½³ä¸½<br>è°­è¯—å®‡<br>é™ˆç§€æ”»</td>
                            <td>é¾šæ¥šæ£®<br>ææµ·è±ª<br>åˆ˜æ™“æ¬¢<br>å½­æ¢…</td>
                            <td>åºé›¯å©•<br>æ¨ä½³é¸¿<br>æè™¹ç‘¶</td>
                            <td>é›·èŒ<br>ææµ·è±ª<br>åˆ˜æ™“æ¬¢<br>å½­æ¢…</td>
                            <td>é™ˆç§€æ”»<br>åˆ˜æ™“æ¬¢<br>é¾šæ¥šæ£®</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="adjustment-form">
            <div class="schedule-title">å€¼ç­è°ƒæ•´ç”³è¯·</div>
            
            <!-- ç™»å½•æç¤º -->
            <div class="login-prompt" id="loginPrompt">
                <strong>âš ï¸ è¯·å…ˆç™»å½•</strong><br>
                æ‚¨éœ€è¦å…ˆåœ¨ä¸Šæ–¹é€‰æ‹©ç”¨æˆ·ç±»å‹å¹¶ç™»å½•ï¼Œæ‰èƒ½æäº¤ç”³è¯·ã€‚
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>ç”³è¯·ç±»å‹</label>
                    <select id="adjustmentType">
                        <option value="è°ƒä¼‘">è°ƒä¼‘</option>
                        <option value="åŠ ç­">åŠ ç­</option>
                        <option value="æ¢ç­">æ¢ç­</option>
                        <option value="è¡¥ä¼‘">è¡¥ä¼‘</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç”³è¯·æ—¥æœŸ</label>
                    <input type="date" id="requestDate">
                </div>
                <div class="form-group">
                    <label>ç”³è¯·äºº</label>
                    <select id="applicant">
                        <option value="">é€‰æ‹©ç”³è¯·äºº</option>
                        <option value="é›·èŒ">é›·èŒ</option>
                        <option value="ç‹ä½³ä¸½">ç‹ä½³ä¸½</option>
                        <option value="é™ˆç§€æ”»">é™ˆç§€æ”»</option>
                        <option value="è°­è¯—å®‡">è°­è¯—å®‡</option>
                        <option value="æè™¹ç‘¶">æè™¹ç‘¶</option>
                        <option value="å½­æ¢…">å½­æ¢…</option>
                        <option value="åºé›¯å©•">åºé›¯å©•</option>
                        <option value="æ¨ä½³é¸¿">æ¨ä½³é¸¿</option>
                        <option value="ææµ·è±ª">ææµ·è±ª</option>
                        <option value="é¾šæ¥šæ£®">é¾šæ¥šæ£®</option>
                        <option value="åˆ˜æ™“æ¬¢">åˆ˜æ™“æ¬¢</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>åŸå€¼ç­æ—¥æœŸ</label>
                    <input type="date" id="originalDate">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>åŸå€¼ç­æ—¶æ®µ</label>
                    <select id="originalTimeSlot">
                        <option value="10:30-13:00">10:30-13:00</option>
                        <option value="15:00-17:30">15:00-17:30</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è°ƒæ•´åæ—¥æœŸ</label>
                    <input type="date" id="newDate">
                </div>
                <div class="form-group">
                    <label>è°ƒæ•´åæ—¶æ®µ</label>
                    <select id="newTimeSlot">
                        <option value="10:30-13:00">10:30-13:00</option>
                        <option value="15:00-17:30">15:00-17:30</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ä»£ç­äººå‘˜</label>
                    <select id="substitute">
                        <option value="">é€‰æ‹©ä»£ç­äººå‘˜</option>
                        <option value="é›·èŒ">é›·èŒ</option>
                        <option value="ç‹ä½³ä¸½">ç‹ä½³ä¸½</option>
                        <option value="é™ˆç§€æ”»">é™ˆç§€æ”»</option>
                        <option value="è°­è¯—å®‡">è°­è¯—å®‡</option>
                        <option value="æè™¹ç‘¶">æè™¹ç‘¶</option>
                        <option value="å½­æ¢…">å½­æ¢…</option>
                        <option value="åºé›¯å©•">åºé›¯å©•</option>
                        <option value="æ¨ä½³é¸¿">æ¨ä½³é¸¿</option>
                        <option value="ææµ·è±ª">ææµ·è±ª</option>
                        <option value="é¾šæ¥šæ£®">é¾šæ¥šæ£®</option>
                        <option value="åˆ˜æ™“æ¬¢">åˆ˜æ™“æ¬¢</option>
                    </select>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="flex: 1;">
                    <label>ç”³è¯·åŸå› </label>
                    <input type="text" id="reason" placeholder="è¯·å¡«å†™ç”³è¯·åŸå› ">
                </div>
            </div>
            <div class="form-row">
                <button class="btn" onclick="addRecord()" id="submitBtn">
                    <span id="submitBtnText">æäº¤ç”³è¯·</span>
                </button>
                <button class="btn btn-warning" onclick="updateRecord()" id="updateBtn" style="display: none;">æ›´æ–°ç”³è¯·</button>
                <button class="btn btn-secondary" onclick="cancelEdit()" id="cancelBtn" style="display: none;">å–æ¶ˆç¼–è¾‘</button>
                <button class="btn export-btn" onclick="exportToCSV()">å¯¼å‡ºCSV</button>
            </div>
        </div>

        <div class="record-table">
            <div class="schedule-title">è°ƒæ•´è®°å½• <span id="recordCount">(åŠ è½½ä¸­...)</span></div>
            <table id="recordTable">
                <thead>
                    <tr>
                        <th style="width: 40px;">åºå·</th>
                        <th style="width: 60px;">ç”³è¯·ç±»å‹</th>
                        <th style="width: 80px;">ç”³è¯·æ—¥æœŸ</th>
                        <th style="width: 60px;">ç”³è¯·äºº</th>
                        <th style="width: 80px;">åŸå€¼ç­æ—¥æœŸ</th>
                        <th style="width: 80px;">åŸå€¼ç­æ—¶æ®µ</th>
                        <th style="width: 80px;">è°ƒæ•´åæ—¥æœŸ</th>
                        <th style="width: 80px;">è°ƒæ•´åæ—¶æ®µ</th>
                        <th style="width: 60px;">ä»£ç­äººå‘˜</th>
                        <th style="width: 150px;">ç”³è¯·åŸå› </th>
                        <th style="width: 70px;">çŠ¶æ€</th>
                        <th style="width: 60px;">å®¡æ‰¹äºº</th>
                        <th style="width: 100px;">å®¡æ‰¹æ—¶é—´</th>
                        <th style="width: 180px;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="recordBody">
                    <!-- æ•°æ®ä»FirebaseåŠ è½½ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getDatabase, ref, push, onValue, remove, update, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBqxHH8p1x0_3z8YmQ6kQ-vMvGwWQb9NM8",
            authDomain: "schedule-management-436010.firebaseapp.com",
            databaseURL: "https://schedule-management-436010-default-rtdb.firebaseio.com",
            projectId: "schedule-management-436010",
            storageBucket: "schedule-management-436010.appspot.com",
            messagingSenderId: "574869352094",
            appId: "1:574869352094:web:c5d7b0a6e8b4c2e7b9f1a8"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const recordsRef = ref(database, 'schedule-records');

        // Global variables
        let currentUser = null;
        let currentUserRole = null;
        let editingRecordId = null;
        let records = [];

        // å®¡æ‰¹å‘˜è´¦å·é…ç½®
        const approverAccounts = {
            'wjl_admin': { password: 'WJL2025!', name: 'ç‹ä½³ä¸½' },
            'lm_admin': { password: 'LM2025!', name: 'é›·èŒ' },
            'lhy_admin': { password: 'LHY2025!', name: 'æè™¹ç‘¶' }
        };
        
        // å€¼ç­äººå‘˜åˆ—è¡¨ï¼ˆæ‰€æœ‰äººéƒ½å¯ä»¥ç”³è¯·ï¼‰
        const staffList = [
            'é›·èŒ', 'ç‹ä½³ä¸½', 'é™ˆç§€æ”»', 'è°­è¯—å®‡', 'æè™¹ç‘¶', 
            'å½­æ¢…', 'åºé›¯å©•', 'æ¨ä½³é¸¿', 'ææµ·è±ª', 'é¾šæ¥šæ£®', 'åˆ˜æ™“æ¬¢'
        ];

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, message) {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('statusText');
            
            statusIndicator.className = `status-indicator ${status}`;
            statusText.textContent = message;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
            document.getElementById('requestDate').valueAsDate = new Date();
            
            // ç›‘å¬Firebaseæ•°æ®å˜åŒ–
            onValue(recordsRef, (snapshot) => {
                const data = snapshot.val();
                records = [];
                
                if (data) {
                    Object.keys(data).forEach(key => {
                        records.push({
                            firebaseId: key,
                            ...data[key]
                        });
                    });
                    
                    // æŒ‰IDæ’åº
                    records.sort((a, b) => (a.id || 0) - (b.id || 0));
                }
                
                updateConnectionStatus('connected', `âœ… å·²è¿æ¥ - å…± ${records.length} æ¡è®°å½•`);
                document.getElementById('recordCount').textContent = `(å…± ${records.length} æ¡)`;
                refreshTable();
            }, (error) => {
                console.error('Firebase connection error:', error);
                updateConnectionStatus('disconnected', 'âŒ è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            });
            
            // åˆå§‹åŒ–UIçŠ¶æ€
            updateUIBasedOnRole();
            
            // æ·»åŠ ç¤ºä¾‹æ•°æ®ï¼ˆä»…åœ¨æ•°æ®åº“ä¸ºç©ºæ—¶ï¼‰
            setTimeout(() => {
                if (records.length === 0) {
                    addExampleData();
                }
            }, 2000);
        };

        function addExampleData() {
            const exampleRecord = {
                id: 1,
                type: 'æ¢ç­',
                requestDate: '2025-09-18',
                applicant: 'åˆ˜æ™“æ¬¢',
                originalDate: '2025-09-18',
                originalTimeSlot: '15:00-17:30',
                newDate: '2025-09-25',
                newTimeSlot: '10:30-13:00',
                substitute: 'ç‹ä½³ä¸½',
                reason: 'éœ€è¦å®Œæˆç›¸å…³ä»»åŠ¡å’Œç‹ä½³ä¸½åŒå­¦æ¢ç­',
                status: 'å¾…å®¡æ‰¹',
                approver: 'â€”',
                approveTime: 'â€”',
                submitter: 'åˆ˜æ™“æ¬¢',
                timestamp: serverTimestamp()
            };
            
            push(recordsRef, exampleRecord).catch(error => {
                console.error('Error adding example data:', error);
            });
        }

        // Make functions globally available
        window.toggleLoginType = function() {
            const userType = document.getElementById('userType').value;
            const adminLogin = document.getElementById('adminLogin');
            const username = document.getElementById('username');
            
            if (userType === 'approver') {
                adminLogin.classList.add('show');
                username.style.display = 'none';
            } else {
                adminLogin.classList.remove('show');
                username.style.display = 'block';
            }
            
            // æ¸…ç©ºè¾“å…¥
            document.getElementById('username').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
        };

        window.login = function() {
            const username = document.getElementById('username').value;
            
            if (!username) {
                alert('è¯·é€‰æ‹©å‘˜å·¥');
                return;
            }

            currentUser = username;
            currentUserRole = 'employee';
            
            completeLogin();
        };

        window.adminLogin = function() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            // éªŒè¯å®¡æ‰¹å‘˜è´¦å·
            if (approverAccounts[username] && approverAccounts[username].password === password) {
                currentUser = approverAccounts[username].name;
                currentUserRole = 'approver';
                completeLogin();
            } else {
                alert('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                document.getElementById('adminPassword').value = '';
            }
        };

        function completeLogin() {
            document.getElementById('currentUsername').textContent = currentUser;
            document.getElementById('currentRole').textContent = getRoleText(currentUserRole);
            document.getElementById('currentRole').className = `role-badge ${currentUserRole}`;
            
            document.querySelector('.user-login').style.display = 'none';
            document.getElementById('adminLogin').classList.remove('show');
            document.getElementById('currentUserInfo').style.display = 'flex';
            
            // æ˜¾ç¤ºå®¡æ‰¹å‘˜æç¤º
            if (currentUserRole === 'approver') {
                document.getElementById('approverNotice').classList.add('show');
            } else {
                document.getElementById('approverNotice').classList.remove('show');
            }
            
            // æ ¹æ®è§’è‰²å¯ç”¨/ç¦ç”¨åŠŸèƒ½
            updateUIBasedOnRole();
            refreshTable(); // åˆ·æ–°è¡¨æ ¼ä»¥æ˜¾ç¤ºæ“ä½œæŒ‰é’®
            
            const roleText = getRoleText(currentUserRole);
            const additionalInfo = currentUserRole === 'approver' ? 
                '\nâœ… æ‚¨å¯ä»¥æäº¤ç”³è¯·ã€æ’¤å›ç¼–è¾‘ã€å®¡æ‰¹ç”³è¯·å’Œåˆ é™¤è®°å½•' : 
                '\nğŸ“ æ‚¨å¯ä»¥æäº¤ç”³è¯·å’Œæ’¤å›ç¼–è¾‘ï¼Œç­‰å¾…å®¡æ‰¹å‘˜å®¡æ‰¹';
            alert(`ç™»å½•æˆåŠŸï¼å½“å‰èº«ä»½ï¼š${roleText}${additionalInfo}`);
        }

        window.logout = function() {
            currentUser = null;
            currentUserRole = null;
            editingRecordId = null;
            
            document.querySelector('.user-login').style.display = 'flex';
            document.getElementById('currentUserInfo').style.display = 'none';
            document.getElementById('approverNotice').classList.remove('show');
            
            // é‡ç½®ç™»å½•è¡¨å•
            document.getElementById('userType').value = 'employee';
            document.getElementById('username').value = '';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminLogin').classList.remove('show');
            document.getElementById('username').style.display = 'block';
            
            // é‡ç½®UI
            resetForm();
            refreshTable();
        };

        function getRoleText(role) {
            const roleMap = {
                'employee': 'æ™®é€šå‘˜å·¥',
                'approver': 'å®¡æ‰¹å‘˜'
            };
            return roleMap[role] || 'æœªçŸ¥';
        }

        function updateUIBasedOnRole() {
            const submitBtn = document.getElementById('submitBtn');
            const loginPrompt = document.getElementById('loginPrompt');
            const submitBtnText = document.getElementById('submitBtnText');
            
            if (currentUser) {
                // ç”¨æˆ·å·²ç™»å½•
                submitBtn.disabled = false;
                submitBtn.style.opacity = '1';
                submitBtn.style.cursor = 'pointer';
                loginPrompt.classList.remove('show');
                submitBtnText.textContent = 'æäº¤ç”³è¯·';
                
                // è‡ªåŠ¨é€‰æ‹©å½“å‰ç”¨æˆ·ä¸ºç”³è¯·äºº
                document.getElementById('applicant').value = currentUser;
            } else {
                // ç”¨æˆ·æœªç™»å½•
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
                submitBtn.style.cursor = 'not-allowed';
                loginPrompt.classList.add('show');
                submitBtnText.textContent = 'è¯·å…ˆç™»å½•';
                
                // æ¸…ç©ºç”³è¯·äºº
                document.getElementById('applicant').value = '';
            }
        }

        function resetForm() {
            // é‡ç½®æŒ‰é’®çŠ¶æ€
            document.getElementById('submitBtn').style.display = 'inline-block';
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('cancelBtn').style.display = 'none';
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('adjustmentType').value = 'è°ƒä¼‘';
            document.getElementById('requestDate').valueAsDate = new Date();
            document.getElementById('applicant').value = currentUser || '';
            document.getElementById('originalDate').value = '';
            document.getElementById('newDate').value = '';
            document.getElementById('substitute').value = '';
            document.getElementById('reason').value = '';
            
            editingRecordId = null;
            updateUIBasedOnRole();
        }

        // æƒé™æ§åˆ¶å‡½æ•°
        function canApprove(record) {
            if (!currentUser) return false;
            return currentUserRole === 'approver';
        }

        function canDelete(record) {
            if (!currentUser) return false;
            return currentUserRole === 'approver';
        }

        function canWithdraw(record) {
            if (!currentUser) return false;
            return currentUser === record.applicant && record.status === 'å¾…å®¡æ‰¹';
        }

        function canSubmit() {
            return currentUser !== null;
        }

        window.addRecord = function() {
            if (!canSubmit()) {
                alert('è¯·å…ˆç™»å½•æ‰èƒ½æäº¤ç”³è¯·');
                return;
            }

            const type = document.getElementById('adjustmentType').value;
            const requestDate = document.getElementById('requestDate').value;
            const applicant = document.getElementById('applicant').value;
            const originalDate = document.getElementById('originalDate').value;
            const originalTimeSlot = document.getElementById('originalTimeSlot').value;
            const newDate = document.getElementById('newDate').value;
            const newTimeSlot = document.getElementById('newTimeSlot').value;
            const substitute = document.getElementById('substitute').value;
            const reason = document.getElementById('reason').value;

            if (!applicant || !originalDate || !reason) {
                alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯ï¼šç”³è¯·äººã€åŸå€¼ç­æ—¥æœŸã€ç”³è¯·åŸå› ');
                return;
            }

            // éªŒè¯ç”³è¯·äººæ˜¯å¦åœ¨å€¼ç­è¡¨ä¸­
            if (!staffList.includes(applicant)) {
                alert('ç”³è¯·äººå¿…é¡»æ˜¯å€¼ç­äººå‘˜');
                return;
            }

            // éªŒè¯ä»£ç­äººå‘˜ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            if (substitute && !staffList.includes(substitute)) {
                alert('ä»£ç­äººå‘˜å¿…é¡»æ˜¯å€¼ç­äººå‘˜');
                return;
            }

            // è·å–å½“å‰æœ€å¤§ID
            const maxId = records.length > 0 ? Math.max(...records.map(r => r.id || 0)) : 0;
            
            const record = {
                id: maxId + 1,
                type: type,
                requestDate: requestDate,
                applicant: applicant,
                originalDate: originalDate,
                originalTimeSlot: originalTimeSlot,
                newDate: newDate || 'â€”',
                newTimeSlot: newTimeSlot,
                substitute: substitute || 'â€”',
                reason: reason,
                status: 'å¾…å®¡æ‰¹',
                approver: 'â€”',
                approveTime: 'â€”',
                submitter: currentUser,
                timestamp: serverTimestamp()
            };
            
            push(recordsRef, record).then(() => {
                resetForm();
                alert('ç”³è¯·æäº¤æˆåŠŸï¼Œç­‰å¾…å®¡æ‰¹å‘˜å®¡æ‰¹');
            }).catch(error => {
                console.error('Error adding record:', error);
                alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        };

        window.withdrawRecord = function(firebaseId) {
            const record = records.find(r => r.firebaseId === firebaseId);
            if (!record) return;

            if (!canWithdraw(record)) {
                alert('åªèƒ½æ’¤å›è‡ªå·±çš„å¾…å®¡æ‰¹ç”³è¯·');
                return;
            }

            if (confirm('ç¡®å®šè¦æ’¤å›è¿™ä¸ªç”³è¯·å¹¶é‡æ–°ç¼–è¾‘å—ï¼Ÿ')) {
                // å¡«å……è¡¨å•
                document.getElementById('adjustmentType').value = record.type;
                document.getElementById('requestDate').value = record.requestDate;
                document.getElementById('applicant').value = record.applicant;
                document.getElementById('originalDate').value = record.originalDate;
                document.getElementById('originalTimeSlot').value = record.originalTimeSlot;
                document.getElementById('newDate').value = record.newDate === 'â€”' ? '' : record.newDate;
                document.getElementById('newTimeSlot').value = record.newTimeSlot;
                document.getElementById('substitute').value = record.substitute === 'â€”' ? '' : record.substitute;
                document.getElementById('reason').value = record.reason;

                // åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼
                editingRecordId = firebaseId;
                document.getElementById('submitBtn').style.display = 'none';
                document.getElementById('updateBtn').style.display = 'inline-block';
                document.getElementById('cancelBtn').style.display = 'inline-block';
                document.getElementById('loginPrompt').classList.remove('show');

                // æ»šåŠ¨åˆ°è¡¨å•
                document.querySelector('.adjustment-form').scrollIntoView({ behavior: 'smooth' });
                
                alert('ç”³è¯·å·²æ’¤å›ï¼Œæ‚¨å¯ä»¥é‡æ–°ç¼–è¾‘åæäº¤');
            }
        };

        window.updateRecord = function() {
            if (!editingRecordId) return;

            const record = records.find(r => r.firebaseId === editingRecordId);
            if (!record) return;

            const type = document.getElementById('adjustmentType').value;
            const requestDate = document.getElementById('requestDate').value;
            const applicant = document.getElementById('applicant').value;
            const originalDate = document.getElementById('originalDate').value;
            const originalTimeSlot = document.getElementById('originalTimeSlot').value;
            const newDate = document.getElementById('newDate').value;
            const newTimeSlot = document.getElementById('newTimeSlot').value;
            const substitute = document.getElementById('substitute').value;
            const reason = document.getElementById('reason').value;

            if (!applicant || !originalDate || !reason) {
                alert('è¯·å¡«å†™å¿…è¦ä¿¡æ¯ï¼šç”³è¯·äººã€åŸå€¼ç­æ—¥æœŸã€ç”³è¯·åŸå› ');
                return;
            }

            // éªŒè¯ç”³è¯·äººæ˜¯å¦åœ¨å€¼ç­è¡¨ä¸­
            if (!staffList.includes(applicant)) {
                alert('ç”³è¯·äººå¿…é¡»æ˜¯å€¼ç­äººå‘˜');
                return;
            }

            // éªŒè¯ä»£ç­äººå‘˜ï¼ˆå¦‚æœå¡«å†™äº†ï¼‰
            if (substitute && !staffList.includes(substitute)) {
                alert('ä»£ç­äººå‘˜å¿…é¡»æ˜¯å€¼ç­äººå‘˜');
                return;
            }

            // æ›´æ–°è®°å½•
            const updates = {
                type: type,
                requestDate: requestDate,
                applicant: applicant,
                originalDate: originalDate,
                originalTimeSlot: originalTimeSlot,
                newDate: newDate || 'â€”',
                newTimeSlot: newTimeSlot,
                substitute: substitute || 'â€”',
                reason: reason,
                status: 'å¾…å®¡æ‰¹',
                approver: 'â€”',
                approveTime: 'â€”'
            };

            const recordRef = ref(database, `schedule-records/${editingRecordId}`);
            update(recordRef, updates).then(() => {
                resetForm();
                alert('ç”³è¯·æ›´æ–°æˆåŠŸï¼Œç­‰å¾…å®¡æ‰¹å‘˜å®¡æ‰¹');
            }).catch(error => {
                console.error('Error updating record:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        };

        window.cancelEdit = function() {
            if (confirm('ç¡®å®šè¦å–æ¶ˆç¼–è¾‘å—ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                resetForm();
            }
        };

        window.approveRecord = function(firebaseId, newStatus) {
            if (!currentUser) {
                alert('è¯·å…ˆç™»å½•');
                return;
            }

            const record = records.find(r => r.firebaseId === firebaseId);
            if (!record) return;

            if (!canApprove(record)) {
                alert('åªæœ‰å®¡æ‰¹å‘˜æ‰èƒ½å®¡æ‰¹ç”³è¯·');
                return;
            }

            if (record.status !== 'å¾…å®¡æ‰¹') {
                alert('æ­¤ç”³è¯·å·²ç»è¢«å¤„ç†è¿‡äº†');
                return;
            }

            const confirmText = newStatus === 'å·²æ‰¹å‡†' ? 'æ‰¹å‡†' : 'æ‹’ç»';
            if (confirm(`ç¡®å®šè¦${confirmText}è¿™ä¸ªç”³è¯·å—ï¼Ÿ\n\nç”³è¯·äººï¼š${record.applicant}\nç”³è¯·ç±»å‹ï¼š${record.type}\nåŸå› ï¼š${record.reason}`)) {
                const updates = {
                    status: newStatus,
                    approver: currentUser,
                    approveTime: new Date().toLocaleString('zh-CN')
                };

                const recordRef = ref(database, `schedule-records/${firebaseId}`);
                update(recordRef, updates).then(() => {
                    alert(`ç”³è¯·å·²${confirmText}ï¼`);
                }).catch(error => {
                    console.error('Error approving record:', error);
                    alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        };

        window.deleteRecord = function(firebaseId) {
            const record = records.find(r => r.firebaseId === firebaseId);
            if (!record) return;

            // åªæœ‰å®¡æ‰¹å‘˜å¯ä»¥åˆ é™¤è®°å½•
            if (!canDelete(record)) {
                alert('åªæœ‰å®¡æ‰¹å‘˜æ‰èƒ½åˆ é™¤è®°å½•');
                return;
            }

            if (confirm(`ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\n\nç”³è¯·äººï¼š${record.applicant}\nç”³è¯·ç±»å‹ï¼š${record.type}\nçŠ¶æ€ï¼š${record.status}`)) {
                const recordRef = ref(database, `schedule-records/${firebaseId}`);
                remove(recordRef).then(() => {
                    // å¦‚æœæ­£åœ¨ç¼–è¾‘è¢«åˆ é™¤çš„è®°å½•ï¼Œå–æ¶ˆç¼–è¾‘
                    if (editingRecordId === firebaseId) {
                        resetForm();
                    }
                    alert('è®°å½•å·²åˆ é™¤');
                }).catch(error => {
                    console.error('Error deleting record:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        };

        function refreshTable() {
            const tbody = document.getElementById('recordBody');
            tbody.innerHTML = '';
            
            records.forEach(record => {
                const row = tbody.insertRow();
                row.className = `type-${record.type}`;
                
                const canApproveThis = canApprove(record);
                const canDeleteThis = canDelete(record);
                const canWithdrawThis = canWithdraw(record);
                
                let actionButtons = '';
                
                // å®¡æ‰¹æŒ‰é’®ï¼ˆä»…å®¡æ‰¹å‘˜å¯è§ï¼Œä¸”çŠ¶æ€ä¸ºå¾…å®¡æ‰¹ï¼‰
                if (record.status === 'å¾…å®¡æ‰¹' && canApproveThis) {
                    actionButtons += `
                        <button class="action-btn approve-btn" onclick="approveRecord('${record.firebaseId}', 'å·²æ‰¹å‡†')">âœ“ æ‰¹å‡†</button>
                        <button class="action-btn reject-btn" onclick="approveRecord('${record.firebaseId}', 'å·²æ‹’ç»')">âœ— æ‹’ç»</button><br>
                    `;
                }
                
                // æ’¤å›ç¼–è¾‘æŒ‰é’®ï¼ˆç”³è¯·äººå¯è§ï¼ŒçŠ¶æ€ä¸ºå¾…å®¡æ‰¹ï¼‰
                if (canWithdrawThis) {
                    actionButtons += `<button class="action-btn withdraw-btn" onclick="withdrawRecord('${record.firebaseId}')">ğŸ”„ æ’¤å›ç¼–è¾‘</button><br>`;
                }
                
                // åˆ é™¤æŒ‰é’®ï¼ˆä»…å®¡æ‰¹å‘˜å¯è§ï¼‰
                if (canDeleteThis) {
                    actionButtons += `<button class="action-btn delete-btn" onclick="deleteRecord('${record.firebaseId}')">ğŸ—‘ï¸ åˆ é™¤</button>`;
                }
                
                // å¦‚æœæ²¡æœ‰ä»»ä½•å¯æ“ä½œæŒ‰é’®ï¼Œæ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
                if (!actionButtons) {
                    if (!currentUser) {
                        actionButtons = '<span style="color: #17a2b8; font-weight: bold;">ç™»å½•åå¯è§æ“ä½œæŒ‰é’®</span>';
                    } else if (record.status !== 'å¾…å®¡æ‰¹') {
                        actionButtons = `<span style="color: #6c757d;">${record.status}</span>`;
                    } else {
                        actionButtons = '<span style="color: #6c757d;">æ— å¯ç”¨æ“ä½œ</span>';
                    }
                }
                
                row.innerHTML = `
                    <td>${record.id || 'â€”'}</td>
                    <td>${record.type}</td>
                    <td>${record.requestDate}</td>
                    <td>${record.applicant}</td>
                    <td>${record.originalDate}</td>
                    <td>${record.originalTimeSlot}</td>
                    <td>${record.newDate}</td>
                    <td>${record.newTimeSlot}</td>
                    <td>${record.substitute}</td>
                    <td style="max-width: 150px; word-wrap: break-word; text-align: left; padding-left: 8px;">${record.reason}</td>
                    <td><span class="status-${record.status}">${record.status}</span></td>
                    <td>${record.approver}</td>
                    <td style="font-size: 10px;">${record.approveTime}</td>
                    <td style="min-width: 180px;">${actionButtons}</td>
                `;
            });
        }

        window.exportToCSV = function() {
            if (records.length === 0) {
                alert('æ²¡æœ‰è®°å½•å¯ä»¥å¯¼å‡º');
                return;
            }

            const headers = ['åºå·', 'ç”³è¯·ç±»å‹', 'ç”³è¯·æ—¥æœŸ', 'ç”³è¯·äºº', 'åŸå€¼ç­æ—¥æœŸ', 'åŸå€¼ç­æ—¶æ®µ', 'è°ƒæ•´åæ—¥æœŸ', 'è°ƒæ•´åæ—¶æ®µ', 'ä»£ç­äººå‘˜', 'ç”³è¯·åŸå› ', 'çŠ¶æ€', 'å®¡æ‰¹äºº', 'å®¡æ‰¹æ—¶é—´'];
            
            let csvContent = headers.join(',') + '\n';
            
            records.forEach(record => {
                const row = [
                    record.id || 'â€”',
                    record.type,
                    record.requestDate,
                    record.applicant,
                    record.originalDate,
                    record.originalTimeSlot,
                    record.newDate,
                    record.newTimeSlot,
                    record.substitute,
                    `"${record.reason}"`,
                    record.status,
                    record.approver,
                    `"${record.approveTime}"`
                ];
                csvContent += row.join(',') + '\n';
            });

            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'å€¼ç­è°ƒæ•´è®°å½•è¡¨.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // Make functions available globally
        window.records = records;
        window.currentUser = currentUser;
        window.currentUserRole = currentUserRole;
    </script>
</body>
</html>
